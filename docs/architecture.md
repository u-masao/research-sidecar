# アーキテクチャ (Architecture)

本ドキュメントでは、システムの技術的な構成要素とディレクトリ構造について解説します。

## 1. 全体構成

本システムは、モダンなPython開発環境と実験管理ツールを組み合わせた構成になっています。

*   **言語・環境:** Python (管理: `uv`)
*   **実験管理:** DVC (Data Version Control)
*   **ワークフロー制御:** Makefile, Shell Scripts
*   **バージョン管理:** Git (Worktree機能を使用)

## 2. ディレクトリ構造

標準的な構成と、実験実行時（Sidecar）の構成があります。

### 2.1. メインリポジトリ (Source)

ソースコードと共通ライブラリを管理する場所です。

```text
.
├── src/                    # 共通ソースコード（再利用可能なモジュール）
├── scripts/                # 運用・実験用スクリプト群
│   ├── cycle.sh            # 実験サイクル制御
│   ├── install.sh          # 自動セットアップ
│   ├── run_experiment.sh   # 個別実験実行ラッパー
│   ├── run_core.sh         # 実験実行のコアロジック (ユーザー定義)
│   ├── sidecar.mk          # 共通Makefileターゲット
│   └── test_workflow.sh    # 動作検証用テストスイート
├── docs/                   # ドキュメント
├── Makefile                # コマンドインターフェース
├── pyproject.toml          # 依存関係定義 (uv/rye)
├── dvc.yaml                # DVCパイプライン定義（テンプレート）
└── AGENTS.md               # AIエージェントへの指示書
```

### 2.2. 実験用ワークツリー (Trials / Sidecar)

`make sidecar-start` などを実行すると、`trials/` ディレクトリに実験専用の環境が作成されます。これは Git Worktree 機能を使用して作成された、独立したブランチ（`experiments` branch）のチェックアウトです。

```text
trials/ (Git Worktree: experiments branch)
  ├── 2024-01-01_12-00-00_feat_xxx/  # 実験ID（タイムスタンプ + ブランチ名等）
  │   ├── spec.md                    # 実験仕様書
  │   ├── reflection.md              # 振り返り
  │   ├── snapshot/                  # 実行時のコードスナップショット (DVC管理)
  │   │   ├── src/
  │   │   └── scripts/
  │   ├── reports/                   # 実験結果 (DVC管理)
  │   │   └── metrics.json
  │   ├── run.log                    # 実行ログ
  │   └── dvc.yaml                   # この実験用のパイプライン定義
  └── ...
```

この構造により、メインの作業ツリー（`.`）は常にクリーンな状態に保たれ、実験結果は `trials/` 以下に隔離されて蓄積されます。

## 3. コンポーネント詳細

### 3.1. 実験ランナー
シェルスクリプトによるモジュール化された構成を採用しています。

*   **`run_experiment.sh`**: 実験の全体フローを管理するラッパーです。
    *   **安全性チェック**: リポジトリがCleanな状態か確認したり、Sidecarの初期化状況をチェックしたりします。
    *   **記録**: 実験の実行履歴（Git Hash）をSidecar内の `ticket.md` に記録します。
*   **`run_core.sh`**: プロジェクト固有の実行ロジックを記述する場所です。
    *   **実行**: `uv run dvc repro` 等のコマンドで実験を実行します。
    *   **収集**: 生成されたレポートを `trials/` ディレクトリにコピーします。

### 3.2. Sidecar Workflow (Git Worktree)
実験結果をメインの履歴（mainブランチ）に混ぜないための仕組みです。
*   `experiments` という孤立ブランチ（Orphan Branch）を作成し、それを `trials/` フォルダにマウントします。
*   実験結果はこの `trials/` 内にコミットされます。
*   これにより、メインブランチの `git log` はソースコードの変更履歴のみとなり、可読性が維持されます。

### 3.3. DVC (Data Version Control)
実験の成果物（モデルファイル、画像、集計結果など）を管理します。
*   コードスナップショットやレポートは `dvc.yaml` によって定義されたパイプラインのアウトプットとして扱われます。
*   これにより、大規模なバイナリファイルもGitリポジトリを肥大化させることなく管理可能です。

### 3.4. AIインタラクションファイル
*   **`spec.md`:** 実験の設計図。AIがコードを生成する際のコンテキストとして機能します。
*   **`reflection.md`:** 実験後の考察。AIエージェントが結果を分析し、ユーザーとの対話を通じて生成します。
*   **`AGENTS.md`:** プロジェクト固有のルールやAIへの指示を記述したファイル。
